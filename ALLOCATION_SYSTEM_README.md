# نظام التوزيعات وصلاحيات المشاريع

## نظرة عامة

تم إضافة نظام توزيعات متقدم يسمح بتحديد حصة كل مكتب من المشروع، مع تطبيق صلاحيات محسّنة للتعديل والحذف.

## الميزات الجديدة

### 1. توزيع حصص المكاتب على المشاريع

#### الفكرة الأساسية
- كل مشروع يمكن تقسيمه إلى حصص محددة لكل مكتب
- كل حصة تحدد:
  - عدد المستفيدين المسموح
  - المبلغ (للمشاريع النقدية)
  - الكمية (للمشاريع العينية)

#### كيفية الاستخدام

1. **عند إنشاء/تعديل مشروع:**
   - انتقل إلى قسم "توزيع الحصص على المكاتب"
   - حدد المكاتب التي ستشارك في المشروع
   - أدخل حصة كل مكتب (عدد المستفيدين + المبلغ/الكمية)

2. **السلوك:**
   - إذا لم يتم تحديد أي توزيعات: جميع المكاتب تستطيع الصرف من المشروع
   - إذا تم تحديد توزيعات: فقط المكاتب المحددة تستطيع الصرف وضمن الحصة المخصصة

#### التحقق التلقائي

النظام يتحقق تلقائياً من:
- عدم تجاوز حصة المكتب عند إضافة مساعدة يدوية
- عدم تجاوز حصة المكتب عند استيراد ملف Excel
- عدم تجاوز إجماليات المشروع في جميع الحالات

### 2. صلاحيات المشاريع المحسّنة

#### للموظفين (Employees)
- **العرض**: يمكن عرض جميع المشاريع
- **الإنشاء**: يمكن إنشاء مشاريع جديدة (تكون تابعة لمكتبهم تلقائياً)
- **التعديل**: فقط المشاريع التابعة لمكتبهم
- **الحذف**: فقط المشاريع التابعة لمكتبهم

#### للإدارة
- كل الصلاحيات متاحة حسب الأدوار المحددة

## البنية التقنية

### الجداول الجديدة

```sql
project_office_allocations
- id
- project_id (FK)
- office_id (FK)
- max_beneficiaries
- max_amount (nullable)
- max_quantity (nullable)
- timestamps
```

### النماذج الجديدة

- `ProjectOfficeAllocation`: يدير العلاقة بين المشروع والمكتب وحصته

### العلاقات

- `Project::officeAllocations()` → HasMany
- `ProjectOfficeAllocation::project()` → BelongsTo
- `ProjectOfficeAllocation::office()` → BelongsTo

## أمثلة على الاستخدام

### مثال 1: مشروع بحصص محددة

**المشروع:** توزيع مساعدات نقدية - 10,000 ₪
- المكتب الشمالي: 5 مستفيدين، 3,000 ₪
- المكتب الجنوبي: 8 مستفيدين، 5,000 ₪
- المكتب الغربي: 7 مستفيدين، 2,000 ₪

**النتيجة:**
- كل مكتب يستطيع فقط صرف حصته المحددة
- إذا حاول أي مكتب تجاوز حصته، سيتم رفض العملية

### مثال 2: مشروع بدون توزيعات

**المشروع:** توزيع مواد غذائية - 1000 طرد
- لم يتم تحديد توزيعات

**النتيجة:**
- جميع المكاتب تستطيع الصرف من المشروع
- الحد الوحيد هو إجماليات المشروع (1000 طرد)

## رسائل الخطأ

### عند تجاوز حصة المكتب
```
"تجاوزت حصة المكتب من المستفيدين (10). المصروف: 8، المتبقي: 2."
```

### عند محاولة الصرف من مكتب غير مسموح
```
"المكتب غير مسموح له بالصرف من هذا المشروع. يرجى مراجعة توزيعات المشروع."
```

### عند محاولة تعديل مشروع غير تابع للمستخدم
```
403 - This action is unauthorized.
```

## ملاحظات مهمة

1. **المشاريع القديمة:** المشاريع الموجودة قبل هذا التحديث تعمل كالمعتاد بدون توزيعات
2. **التحقق المزدوج:** النظام يتحقق من حصة المكتب بالإضافة إلى إجماليات المشروع
3. **الأداء:** يتم حساب المستهلك لكل مكتب عند الحاجة من جدول `aid_distributions`
4. **الصلاحيات:** أزرار التعديل/الحذف تظهر فقط للمشاريع التي يملك المستخدم صلاحية عليها

## التطويرات المستقبلية المقترحة

1. إضافة تقرير يوضح استهلاك كل مكتب من حصته
2. إشعارات عند اقتراب المكتب من استنفاد حصته
3. إمكانية نقل جزء من حصة مكتب إلى مكتب آخر
4. عرض التوزيعات في تفاصيل المشروع

---

تم التطوير بتاريخ: 26 فبراير 2026
