حنعمل تعديل كبير شوي في النظام

وهو اضافة جدول المشاريع يحتوي على :

- رقم المشروع (رقم تسلسلي في الغالب تلقائي لكن يمكن التحكم به اي انواع معينة الها تسلسل خاص لكنه فريد)
- اسم المشروع
- المؤسسة التابع لها (من خلال جدول المؤسسات)
- نوع المشروع (عيني أو نقدي)  (in_kind وcash )
- الصنف (اختياري) (من جدول الاصناف اذا كان عيني)
- الكمية الإجمالية (وهية قديش في كمية من الصنف هذا عنا إذا كان مشروع عيني)
- الكمية المستهلكة (تتحدث عند الإضافة او التعديل على المساعدات فقط بداية يكون 0)
- المبلغ التقديري (حقل اذا كان عيني يحط المدير قديش المبلغ التقديري للأصناف)
- المبلغ الإجمالي بالشيكل (وهو لو كانت نقدية فقديش المبلغ)
- المبلغ المصروف (لمن تكون نقدية ، تتحدث عند الإضافة او التعديل على المساعدات فقط بداية يكون 0)
- عدد المستفيدين (عدد المساعدات المسموح اخدها)
- عدد المستفيدين الحاصلين (تتحدث عند الإضافة او التعديل على المساعدات فقط بداية يكون 0)
- المنشىء (مين المستخدم الي عمله)
- التبعية (لفرع معين اذا كان موظف الي ادخله او للإدارة اذا كان مدير الي ادخله) (هذا الحقل حنستخدمه في تحديد رقم المشروع على اي تسلسل حيمشي كل مكتب حنعمله تسلسل والادارة الها تسلسل خاص)

حقل المنشئ والتبعية والرقم للمشروع تلقائي ما حد بتحكم فيهم ولكن ممكن بعد نغيرهم ليكونوا يدوي فكون مخلي الامر مسموح يعني لكن افتراضي حيكون تلقائي

---

جدول عرض اي view للمشاريع يكون فيها 

- رقم المشروع
- اسم المشروع
- عدد المساعدات المرتبط فيها
- الكمية الإجمالي
- الكمية المصروفة
- الكمية المتبقية
- المبلغ المصروف
- المبلغ المتبقى
- عدد المستفيدين الإجمالي / المصروفة له / المتبقى

هذا view بس عشان وقت جلب البيانات الاخيرة ونستخدمها في الفورم المساعدات او التحليل فيكون جاهز

---

- هيك جدول المشاريع الي بدنا نسويه في جزء بناء crud خد الفكرة من المساعدات
    - index.blade.php / create / edit / _form
- وعندك view كمان اعمل للاتنين مودلين مزبطات واضحات
- وضيفه في asideH للجدول عشان يوصله وضيفله obsererves , policy كمان وضيفه داخل ملف data/ablilites.php جزء الصلاحيات اله


---

بعد الانتهاء من بدنا نربط المساعدات في المشاريع حيصير كل مساعدة تابعة لمشروع واحد فقط والعكس المشروع يحتوي على عدة مساعدات 

- الربط من خلال حقل جديد id الخاص في المشروع

الشغل اغلبه حيكون في ملف _form الخاص بالمساعدة من خلال حقل جديد المشاريع الموجودة بس اذا اختار مؤسسة تطلعله المشاريع تاعتها بشكل مباشر وينقي منهم ويجيب وتخزن في سمات الحقل شو الكمية او المبلغ الإجمالي حسب المشروع يعني يتخزنوا الاتنين وكمان عدد المستفيدين 

بحيث لمن يجي يحدد نوع المساعدة الجديدة وبده يحدد الحين قديش المبلغ للمساعدة أوقديش الكمية في هاي اللحظة بدي يطلعله رسالة تحت الحقل نفسه تاع الكمية او المبلغ واضحه انه متبقى مبلغ (س) او كمية (س) في المشروع هذا وطبعا تكون بتتغير مع قديش القيمة الي بحطها في الحقل للمساعدة بحيث الموظف يعرف شو المشروع ضايله فيه ومسموح قديش 
وطبعا اذا عدد المستفيدين امتلاء يطلع رسالة عطول عند تحديد المشروع انه المشروع هذا ممتلاء ما بتقدر تضيف غير المشروع الي مختاره انت 

- ركز كويس في الفورم لمن يكون تعديل او انشاء مساعدة جديدة في المعادلات عشان لحظة الخصم اول مرة واذا اجا يعدل تاني مرة على مساعدة موجودة يفهم كيف الية الحساب تكون لقديش متبقى سواء مبلغ او كمية  difference = new_value - old_value في جزء التعديل
- طبعا موضوع تجيب عدد المستفيدين والكمية والمبلغ المتبقيين من خلاله view الي معمولة فوق بحيث تجيب اخر اشي متبقى وقديش ضايل وتتعامل كويس

---

## قرارات ثابتة قبل الشغ

1. **رقم المشروع فريد** على مستوى النظام كله (Unique).
2. **المشروع النقدي**: يعتمد على `total_amount` و `consumed_amount` فقط.
3. **المشروع العيني**: يعتمد على `total_quantity` و `consumed_quantity` فقط.
4. **consumed_**لا تتعدل من أي فورم/CRUD نهائياً، فقط من Service Layer مع Transaction + Lock.
5. **عدد المستفيدين = عدد عمليات الصرف** (كما قلت)

---

## الجزء التاني

- في ملف الاكسيل الشغل حيكون الفحص والتجميع قبل اي عملية تخزين على الملف ككله
    - وتمر في 3 مستويات، فحص في الملف نفسه، فحص في DB وفحص قيود المشروع
- عدل في استيراد ملف الاكسيل عدل المكتب انه يكون من المستخدم مباشر ما يحتاج يضيفه هو الا اذا مدير اما اذا موظف عادي يوخد المكتب تاعه مباشرة
- الملف حيكون لمشروع واحد بالغالب لكن ممكن يكون اكثر من مشروع وبدنا نعرف نتعامل مع عدة المشاريع هاي
- شيل المؤسسة من ملف الاكسيل وخليه يجي من خلال رقم المشروع (`"rkm_almshroaa" => 21313`) الي بيجي من ملف الاكسيل مباشرة فعدل في استيراد ملف الاكسيل انه حيستورد رقم المشروع حيجيب منه id تاع المشروع وكمان حيجيب المؤسسة مباشرة ويتخزن في الحقل تاعه
- تجميع كل المستفيدين من ملف الاكسيل قبل الانشاء ان في متكررين بدك تظهر للمستخدم جدول فيه المتكررين وزر جنب للموافقة على كل واحد، التكرار يكون في نفس الشهر الي فيه المساعدة وقتها بظهر رسالة انه فلان مكرر وفيه اله مساعدة تانية وحتى لو في نفس الملف بس في نفس الشهر يبقى تطلعله انه المستخدم كذا اله اتنين من المساعدات مكررة اخدهم فما بنفع الا بموافقة المستخدم عليه بالاول بعدين ما يخلص موافقة او رفض لعدد يتخزنوا البيانات في الجدول الاساسي مباشر
- كل المساعدات الاصل مرتبطة في مشروع واحد الحين من خلال رقم المشروع بيجي من الاكسيل بنحدد وقتها المشروع قديش مستفدين متبقى او كمية مسموح صرفها او مبلغ هذول مهم فحصهم من كل الملف تاع الاكسيل هل اكثر من المسموح سواء عدد اكبر سواء كمية او مبلغ مالي اكثر، من خلال الفحص من داخل view الخاص به، ما بخزن اشي من الملف ابدا وبطلعله رسالة في صفحة الاستيراد انه عندك مشكلة وانه عدد المستفيدين المتبقى في المشروع الي رفعته ورقمه كذا واسمه مسموح لك عدد (س) او كمية او مبلغ، والعدد الي عندك مثلا (س) او الكمية المصروفة كذا او السعر المصروف، وما يخزن اشي ليحل المشاكل

---

## الجزء الثالث

- في صفحة index التحليلات، بدنا نضيف جزء يعرض كل المشاريع الموجودة ويعرض جنبها قديش عدد المستفيدين التوتل وكم المستفيدي الحيالين وقديش متبقى وكذلك للكمية وللسعر بشكل بسيط يعرض كل المشاريع فيها بشكل بسيط بجدول خفيف وعند الضغط على العين يطلع pop فيها تفاصيل المشروع وجدول الموظف كذا من المكتب كذا صرف لعدد مستخدمين هالقد والكمية او السعر الي انصرفوا كتوكل هيك بدي اياه

---

## ملاحظات مهمة

- كل عمليات الخصم والتعديل تتم داخل Transaction مع Lock.

- يمنع تعديل consumed_* من أي مكان خارج Service Layer.
 

- إذا تجاوز ملف الإكسيل القيود يتم رفض الملف بالكامل.
 

- الفرق في التعديل يُحسب عبر `difference = new - old` وليس إعادة حساب كامل.