# منطق التحقق من حصص المكاتب

## نظرة عامة

تم تحسين منطق التحقق من حصص المكاتب ليدعم سيناريوهات مرنة ومتقدمة في إدارة المشاريع.

## السيناريوهات المدعومة

### 1. تحديد عدد المستفيدين فقط

**الإعداد:**
```
عدد المستفيدين: 50
المبلغ: لم يُحدد
الكمية: لم يُحدد
```

**السلوك:**
- يستطيع المكتب صرف حتى 50 مستفيد
- المبلغ/الكمية غير محدود (يتحقق من إجماليات المشروع فقط)

---

### 2. تحديد المبلغ/الكمية فقط (بدون عدد مستفيدين)

**الإعداد - مشروع نقدي:**
```
عدد المستفيدين: 0 أو فارغ
المبلغ: 10,000 ₪
```

**السلوك:**
- **الحد الأقصى للمستفيدين**: المتبقي في المشروع الأساسي
- **الحد الأقصى للمبلغ**: 10,000 ₪

**مثال:**
```
المشروع الأساسي:
- إجمالي المستفيدين: 200
- المتبقي: 150 مستفيد
- إجمالي المبلغ: 50,000 ₪

المكتب الشمالي:
- حصة المستفيدين: غير محددة → سيستخدم 150 (المتبقي في المشروع)
- حصة المبلغ: 10,000 ₪

النتيجة:
✓ يستطيع صرف حتى 150 مستفيد
✓ لكن ضمن حد 10,000 ₪ فقط
✓ إذا وصل لـ 10,000 ₪ قبل 150 مستفيد، يتوقف
```

---

### 3. تحديد كلاهما (الأفضل)

**الإعداد:**
```
عدد المستفيدين: 50
المبلغ: 15,000 ₪
```

**السلوك:**
- يجب عدم تجاوز 50 مستفيد
- يجب عدم تجاوز 15,000 ₪
- أيهما يُستنفد أولاً يوقف الصرف

---

### 4. عدم تحديد أي شيء (خطأ)

**الإعداد:**
```
عدد المستفيدين: 0 أو فارغ
المبلغ: لم يُحدد
الكمية: لم يُحدد
```

**السلوك:**
- ❌ **يُرفض تماماً**
- رسالة الخطأ: "المكتب ليس له حصة محددة من هذا المشروع"

---

## أمثلة تطبيقية

### مثال 1: مشروع نقدي مع توزيعات مختلطة

```
المشروع: توزيع مساعدات نقدية
- إجمالي المستفيدين: 300
- إجمالي المبلغ: 150,000 ₪
- المتبقي: 200 مستفيد، 100,000 ₪

التوزيعات:
1. المكتب الشمالي:
   - المستفيدين: 50
   - المبلغ: 25,000 ₪
   → الحد: 50 مستفيد و 25,000 ₪

2. المكتب الجنوبي:
   - المستفيدين: (غير محدد)
   - المبلغ: 30,000 ₪
   → الحد: 200 مستفيد (المتبقي في المشروع) و 30,000 ₪
   
3. المكتب الغربي:
   - المستفيدين: 80
   - المبلغ: (غير محدد)
   → الحد: 80 مستفيد، المبلغ غير محدود (ضمن المشروع)
```

---

### مثال 2: سيناريو الاستنفاد بالمبلغ

```
المكتب: المكتب الشرقي
الإعداد:
- المستفيدين: غير محدد → يستخدم المتبقي (100 مستفيد)
- المبلغ: 5,000 ₪

الصرف:
1. مستفيد 1: 500 ₪ → مجموع 500 ₪ ✓
2. مستفيد 2: 800 ₪ → مجموع 1,300 ₪ ✓
3. مستفيد 3: 1,200 ₪ → مجموع 2,500 ₪ ✓
...
10. مستفيد 10: 600 ₪ → مجموع 5,100 ₪ ✗

النتيجة:
❌ رُفض المستفيد 10
السبب: تجاوز حد المبلغ (5,000 ₪)
المصروف: 9 مستفيدين فقط من أصل 100 مسموح
```

---

## التحقق في الاستيراد (Excel)

عند استيراد ملف Excel، يتم:

1. **تجميع البيانات حسب (المشروع، المكتب)**
2. **حساب المجاميع:**
   - عدد المستفيدين المطلوب
   - المبلغ الإجمالي (للنقدي)
   - الكمية الإجمالية (للعيني)

3. **جلب المصروف الحالي من قاعدة البيانات:**
   - عدد المستفيدين المصروف
   - المبلغ المصروف
   - الكمية المصروفة

4. **التحقق:**
   ```
   المطلوب + المصروف ≤ الحد الأقصى
   ```

5. **رسائل الخطأ التفصيلية:**
   ```
   "المكتب الشمالي: المستفيدين المطلوبين (30) + المصروف (25) = 55 
    يتجاوز حصة المكتب (50). المتبقي: 25"
   ```

---

## التحقق في الإضافة اليدوية

نفس المنطق يُطبق عند إضافة مساعدة يدوية واحدة:

1. يتحقق من حصة المكتب
2. يحسب المستهلك الحالي
3. يضيف المطلوب الجديد
4. يقارن بالحد الأقصى
5. يرفض أو يقبل

---

## حالات خاصة

### إذا لم يكن للمشروع توزيعات

```php
if (!$project->officeAllocations()->exists()) {
    // لا توجد قيود خاصة بالمكاتب
    // التحقق فقط من إجماليات المشروع
    return;
}
```

### عند تعديل مساعدة موجودة

```php
// يُستثنى السجل الحالي من الحساب
->when($existingDistribution, function ($q) use ($existingDistribution) {
    $q->where('id', '!=', $existingDistribution->id);
})
```

---

## رسائل الخطأ

### 1. مكتب غير مسموح
```
"المكتب [اسم المكتب] غير مسموح له بالصرف من المشروع [رقم المشروع]"
```

### 2. لا توجد حصة محددة
```
"المكتب [اسم المكتب] ليس له حصة محددة من المشروع [رقم المشروع]. 
 يجب تحديد على الأقل عدد المستفيدين أو المبلغ/الكمية."
```

### 3. تجاوز عدد المستفيدين
```
"المكتب [اسم المكتب]: المستفيدين المطلوبين (X) + المصروف (Y) = Z 
 يتجاوز [حصة المكتب/المتبقي في المشروع] (W). المتبقي: V"
```

### 4. تجاوز المبلغ
```
"المكتب [اسم المكتب]: المبلغ المطلوب (X ₪) + المصروف (Y ₪) = Z ₪ 
 يتجاوز حصة المكتب (W ₪). المتبقي: V ₪"
```

### 5. تجاوز الكمية
```
"المكتب [اسم المكتب]: الكمية المطلوبة (X) + المصروف (Y) = Z 
 يتجاوز حصة المكتب (W). المتبقي: V"
```

### 6. حد غير محدد
```
"المكتب [اسم المكتب]: يجب تحديد حد للمبلغ أو عدد المستفيدين 
 في المشروع النقدي [رقم المشروع]"
```

---

## الكود المعني

### ملفات محدثة:

1. **`app/Services/AidDistributionImportService.php`**
   - الدالة: `validateOfficeAllocations()`
   - التحقق عند استيراد Excel

2. **`app/Services/ProjectConsumptionService.php`**
   - الدالة: `validateOfficeAllocation()`
   - التحقق عند الإضافة اليدوية

---

## نصائح للاستخدام

### ✅ أفضل الممارسات

1. **حدد كلا الحدين** (مستفيدين + مبلغ/كمية) لتحكم كامل
2. **استخدم المبلغ/الكمية فقط** عندما تريد حداً مالياً/كمياً مع مرونة في العدد
3. **راجع التوزيعات بانتظام** للتأكد من توافقها مع الاحتياجات الفعلية

### ⚠️ تحذيرات

1. **لا تترك كل الحقول فارغة** - سيُرفض المكتب
2. **تأكد من مجموع التوزيعات** - يجب ألا يتجاوز إجماليات المشروع
3. **راقب المصروف الحالي** - قد يقلل من المتاح للصرف الجديد

---

تم التحديث: 26 فبراير 2026
